# SOOP Chatting Crawling - 기술 분석 및 최적화 보고서

본 문서는 `soop_chat.py` 프로젝트의 핵심 기술 구현 방식과 서버 리소스 절감을 위한 최적화 전략을 상세히 기술합니다.

---

## 1. SOOP 웹소켓 데이터 파싱 (Reverse Engineering)

SOOP(아프리카TV)의 채팅 시스템은 HTTP가 아닌 **TCP/WebSocket**을 통해 바이너리/텍스트 혼합 패킷으로 통신합니다. 이를 브라우저 없이 직접 구현하기 위해 프로토콜을 역공학(Reverse Engineering)하여 구현했습니다.

### A. 패킷 패킹 및 핸드쉐이크 (Handshake)

서버와 통신하기 위해서는 데이터 앞에 **12자리 헤더**를 붙여야 합니다.

```python
# F = 구분자 (\x0c)
# ESC = 이스케이프 (\x1b\t)
header = f"{service_type}{len(body_bytes):06}00"
packet = ESC + header + body_bytes
```

1.  **CONNECT**: 웹소켓 연결 (SSL 적용).
2.  **LOGIN (0001)**: 최초 접속 시 불필요한 데이터를 제외한 간소화된 로그인 패킷 전송.
3.  **JOIN (0002)**: `broadcast_info`에서 획득한 `CHATNO`(채팅방번호)와 `FTK`(입장 토큰)를 사용하여 입장 패킷 전송. 이 단계가 성공해야 실시간 데이터를 수신할 수 있습니다.

### B. 데이터 구조 파싱 (Parsing Logic)

수신된 데이터는 바이트 스트림 형태이며, `\x0c` (Form Feed) 제어 문자를 구분자(Delimiter)로 사용하여 데이터를 쪼갭니다(`split`).

#### 1. 일반 채팅 (ServiceType: 0005)
```
[Header] | [Message] | [UID] | [Nickname] | [Flags] ...
```
-   **메시지**: `parts[1]`
-   **닉네임**: `parts[6]`
-   **유저 권한**: `parts[7]` (비트 플래그)

#### 2. 별풍선 후원 (ServiceType: 0018)
```
[Header] | [UID] | ... | [Nickname] | [Count] ...
```
-   **닉네임**: `parts[3]`
-   **개수**: `parts[4]` (기존 0012 패킷 분석과 달리 0018에서는 인덱스 4번에 위치함)

---

## 2. 서버 비용 절감을 위한 최적화 (Optimization Logic)

이 프로젝트는 월 $0 (Oracle Free Tier) 또는 월 5,000원 이하의 초저사양 VPS에서도 안정적으로 동작하도록 설계되었습니다.

### A. 의존성 제거 (Zero-Dependency)
-   **변경 전**: `requests` 라이브러리 사용 (별도 설치 필요, 무거운 의존성).
-   **변경 후**: `urllib` (Python 표준 라이브러리) 사용.
-   **이점**: 컨테이너 이미지 크기 감소, 설치 속도 향상, 메모리 오버헤드 감소.

### B. 메모리 폭증 방지 (Worker Pattern)
-   **문제점**: 채팅이 초당 1,000개 이상 쏟아지는 대형 방송(Burning Mode) 시, 각 패킷마다 `asyncio.create_task`를 생성하면 **OOM(Out Of Memory)** 발생 위험.
-   **해결책**: **Producer-Consumer 패턴** 도입.
    -   `ws.recv()`는 데이터를 받아 `asyncio.Queue`에 넣기만 함 (Producer).
    -   3개의 고정된 **Worker**가 큐에서 하나씩 꺼내 처리 (Consumer).
-   **효과**: 입력 부하가 처리 속도를 초과해도 메모리가 큐 크기만큼만 사용되며, CPU 점유율이 일정하게 유지됨.

### C. CPU 연산 최적화 (Caching)
-   **적용 대상**: `parse_flags` (유저 뱃지 파싱).
-   **기법**: `functools.lru_cache(maxsize=1024)` 적용.
-   **이유**: 방송 중 채팅하는 사람은 소수의 헤비 유저가 대부분입니다. 동일한 유저가 채팅할 때마다 비트 연산과 문자열 포맷팅을 반복하는 것은 낭비입니다.
-   **효과**: 자주 보이는 시청자의 뱃지 파싱 연산을 O(1)로 단축.

---

## 3. 결론

이 코드는 단순한 스크립트가 아니라, **대규모 트래픽을 견딜 수 있는 구조(Queue, Caching)**와 **최소한의 리소스(Standard Lib)**로 설계된 고효율 크롤링 엔진입니다.

## 프로젝트 리포트: SOOP 실시간 데이터 파싱 엔진

###  프로젝트 개요

목적: SOOP(아프리카TV)의 웹소켓(WebSocket) 프로토콜을 분석하여 별도의 브라우저 없이 실시간 채팅 데이터와 후원(별풍선) 정보를 수집 및 정제하는 고성능 크롤링 엔진 구축.

배경: 기존 Selenium 기반 크롤링의 높은 리소스 점유율과 낮은 실시간성을 극복하기 위해 서버와 클라이언트 간의 저수준(Low-level) 패킷 통신을 직접 제어함.

### 프로젝트 핵심 로직 및 구현 방식

A. 웹소켓 핸드쉐이크 (Handshake)

1단계 (Connect): 서버와의 초기 소켓 연결을 확립 (ServiceType 0001).

2단계 (Join): 특정 방송방(CHATNO)에 입장하기 위해 FTK(인증 티켓)를 포함한 패킷 송신 (ServiceType 0002).

비회원 접속 최적화: 복잡한 로그인 쿠키 없이도 데이터를 수집할 수 있도록 비회원 전용 핸드쉐이크 구조 설계.

B. 패킷 구조 및 데이터 파싱

12자리 헤더 규칙: SOOP 전용 패킷 규격인 명령어(4자리) + 바디 길이(6자리) + 예비(2자리) 형식을 create_packet 함수로 자동화하여 구현.

구분자 분석: 바이트 데이터 내의 특수 구분자(\x0c, 상수 F)를 기준으로 데이터를 분할하여 닉네임, 메시지, 유저 플래그 등을 정확한 인덱스에서 추출.

C. 비트 플래그 기반 유저 상태 판별

비트 마스킹(Bit Masking): 서버에서 전달되는 정수형 플래그 값을 비트 단위로 연산(&)하여 유저의 권한(BJ, 매니저, 구독자, 열혈팬, 팬클럽)을 실시간으로 식별하고 배지로 표시.

D. 안정성 및 최적화 (Self-Healing)

수동 핑(Manual Ping): 라이브러리 자동 핑 대신 서버 규격에 맞는 0000 패킷을 주기적으로 송신하여 타임아웃(ConnectionClosedError) 방지.

자동 재접속: 방송 종료나 네트워크 순단 시 10초 이내에 정보를 갱신하여 자동으로 재연결하는 루프 구조 설계.

비동기 병렬 처리: asyncio.create_task를 활용하여 데이터 수신과 파싱을 분리, 초당 수천 개의 트래픽이 발생하는 대형 방송에서도 지연 없는 처리 가능.

### 주요 참고 리소스 및 기술적 가치
참고 리소스	핵심 추출 내용	프로젝트 반영 사항
채수현 개발일지	웹소켓 분석의 시초, 초기 핸드쉐이크 값 확인	기본적인 소켓 연결 메커니즘 구축
DOCHIS(헛삯) 분석	패킷 헤더의 12자리 규칙 및 동적 바이트 길이 계산의 중요성 강조	create_packet 함수 및 동적 헤더 생성 로직 구현
HO-Silverplate Gist	서비스 타입(0005, 0104 등) 및 채팅 패킷의 상세 인덱스 명세	정확한 채팅/공지/후원 데이터 분류 체계 수립
SSAPI 개발 회고	대규모 트래픽 처리 경험, 리소스 절감(Snappy 압축 언급) 및 비용 최적화 철학	비동기 병렬 처리 및 이벤트 선택 수신(Mode) 기능 도입

### 상세 ServiceType 정의 (패킷 명세 기반)

0000 (PING): 연결 유지를 위한 하트비트.

0001 (LOGIN): 서버 초기 접속 확인.

0002 (JOIN): 특정 채팅방 입장 승인.

0005 (CHATTING): 일반 사용자 채팅 메시지.

0012 (BALLOON): 별풍선 후원 발생 (개수, 닉네임 포함).

0104 (NOTICE): 방송 상단 공지사항 및 운영 메시지.

### 결론 및 향후 발전 방향

본 프로젝트는 **안정성(Fail-over)**과 **효율성(Low-latency)**에 집중하여 설계되었습니다. 단순히 채팅을 읽는 것을 넘어, 유저의 상태를 실시간으로 분석하고 후원 데이터를 통계화할 수 있는 강력한 데이터 수집 기반을 갖추었습니다.

다음 단계 제안:

데이터 저장: 수집된 채팅을 SQLite나 JSONL 포맷으로 실시간 저장하여 분석용 데이터셋 구축.

통계 대시보드: 세션 동안의 총 별풍선, 가장 많이 언급된 단어 등을 시각화하는 웹 대시보드 연결.

알림 봇 연동: 특정 열혈팬 입장이나 대량 후원 발생 시 Discord/Telegram 알림 전송 기능 추가.

[채수현 개발일지] - 아프리카TV 실시간 채팅 크롤링의 기초 메커니즘 제공

[DOCHIS(헛삯)] - 패킷 헤더의 6자리 길이 계산 규칙 및 운영 안정성 철학 정립

[HO-Silverplate] - ServiceType 및 채팅 패킷 인덱스 상세 명세 제공